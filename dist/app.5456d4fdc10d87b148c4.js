!function(n){var e={};function t(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return n[i].call(a.exports,a,a.exports,t),a.l=!0,a.exports}t.m=n,t.c=e,t.d=function(n,e,i){t.o(n,e)||Object.defineProperty(n,e,{enumerable:!0,get:i})},t.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},t.t=function(n,e){if(1&e&&(n=t(n)),8&e)return n;if(4&e&&"object"==typeof n&&n&&n.__esModule)return n;var i=Object.create(null);if(t.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:n}),2&e&&"string"!=typeof n)for(var a in n)t.d(i,a,function(e){return n[e]}.bind(null,a));return i},t.n=function(n){var e=n&&n.__esModule?function(){return n.default}:function(){return n};return t.d(e,"a",e),e},t.o=function(n,e){return Object.prototype.hasOwnProperty.call(n,e)},t.p="",t(t.s=0)}({0:function(n,e,t){t("9kT/"),t("VTQ0"),t("0ykG"),t("ZhS1"),t("ruhI"),t("IyPb"),t("HFjc"),t("VbJc"),t("Vqn6"),t("sAuz"),t("uu6i"),t("i/hi"),t("6ibp"),t("67am"),t("7Sbx"),n.exports=t("oXHG")},"0ykG":function(n,e){!function(n){"use strict";function e(n,e,t,i,a,r,o,c){c.isConfigured().then((function(c){if(c){var s=new o.DynamicDirective((function(){return!0}),"inbox-linshare-composer-select-attachment",{attributes:[{name:"email",value:"$ctrl.message"}]}),u=new o.DynamicDirective((function(){return!0}),"inbox-linshare-composer-select-attachment",{attributes:[{name:"email",value:"$ctrl.message"},{name:"is-mobile",value:"true"}]});o.addInjection("inboxComposerExtraButtons",s),o.addInjection("inboxMobileComposerExtraButtons",u),n.add(e),a.registerPreSendingHook(t),r.registerPreComposingHook(i)}}))}function t(n){var e=new n.DynamicDirective(!0,"inbox-linshare-attachment-save-action",{attributes:[{name:"attachment",value:"attachment"}],priority:-10});n.addInjection("attachments-action-list",e)}e.$inject=["inboxAttachmentProviderRegistry","inboxLinshareAttachmentProvider","inboxLinsharePresendingHook","inboxLinsharePrecomposingHook","inboxEmailSendingHookService","inboxEmailComposingHookService","dynamicDirectiveService","linshareConfigurationService"],t.$inject=["dynamicDirectiveService"],n.module("linagora.esn.unifiedinbox.linshare").run(e).run(t)}(angular)},"67am":function(n,e){!function(n){"use strict";function e(n,e,t,i){return function(a){var r=t.getLinShareAttachmentUUIDsFromEmailHeader(a);r.length&&r.forEach((function(r){var o,c={uuid:r,attachmentType:i,status:"loading"};o=c,e.getDocument(o.uuid).then((function(e){n.assign(o,t.documentToAttachment(e))})).catch((function(){o.status="load-error"})),a.attachments.push(c)}))}}e.$inject=["_","linshareApiClient","inboxLinshareHelper","INBOX_LINSHARE_ATTACHMENT_TYPE"],n.module("linagora.esn.unifiedinbox.linshare").factory("inboxLinsharePrecomposingHook",e)}(angular)},"6ibp":function(n,e){!function(n){"use strict";function e(e,t,i){return{documentToAttachment:function(a){return{attachmentType:t,name:a.name,size:a.size,type:a.type||i,upload:{promise:e.when(),cancel:n.noop},uuid:a.uuid,status:"uploaded"}},getLinShareAttachmentUUIDsFromEmailHeader:function(n){return n.headers&&n.headers.LinShareAttachmentUUIDs?n.headers.LinShareAttachmentUUIDs.trim().split(","):[]},setLinShareAttachmentUUIDsToEmailHeader:function(n,e){n.headers=n.headers||{},n.headers.LinShareAttachmentUUIDs=e.join(",")}}}e.$inject=["$q","INBOX_LINSHARE_ATTACHMENT_TYPE","DEFAULT_FILE_TYPE"],n.module("linagora.esn.unifiedinbox.linshare").factory("inboxLinshareHelper",e)}(angular)},"7Sbx":function(n,e){!function(n){"use strict";function e(n,e,t,i,a,r,o){return function(c){var s=e.remove(c.attachments,(function(n){return n.attachmentType===r})).map((function(n){return n.uuid})).filter(Boolean),u=a.getAllRecipientsExceptSender(c).map((function(n){return{mail:n.email}}));if(!s.length||!u.length)return n.when();var l=s.length>1?t.translate(o.plural,s.length).toString():t.translate(o.singular).toString(),h='<br /><p style="font-family: Roboto; font-size: 12px; color: rgba(0,0,0,0.65); text-align: center"><i>'+l+"</i></p>",m="\n\n-----------------------------------\n"+l;return i.shareDocuments({documents:s,recipients:u}).then((function(){c.htmlBody=c.htmlBody?c.htmlBody+=h:h,c.textBody=c.textBody?c.textBody+=m:m}))}}e.$inject=["$q","_","esnI18nService","linshareApiClient","emailSendingService","INBOX_LINSHARE_ATTACHMENT_TYPE","INBOX_LINSHARE_EMAIL_ADDITIONAL_MESSAGE_TEMPLATES"],n.module("linagora.esn.unifiedinbox.linshare").factory("inboxLinsharePresendingHook",e)}(angular)},"9kT/":function(n,e){!function(n){"use strict";n.module("linagora.esn.unifiedinbox.linshare",["restangular","esn.async-action","esn.http","esn.background","esn.core","esn.file","esn.i18n","esn.lodash-wrapper","esn.configuration","linagora.esn.unifiedinbox","linagora.esn.linshare"])}(angular)},HFjc:function(n,e){!function(n){"use strict";function e(n,e,t,i,a,r,o){return{getAttachmentMapping:function(n){return r.getAttachments({blobId:n.blobId,limit:1}).then((function(n){if(Array.isArray(n)&&1===n.length)return n[0]}))},saveAttachmentToLinshare:function(e){var t=e.getSignedDownloadUrl().then((function(n){return a.createDocumentFromUrl({url:n,fileName:e.name},{async:!0})})).then((function(t){if(t.status===a.ASYNC_TASK_STATUS.FAILED)return n.reject(new Error("Cannot save attachment to LinShare"));var i={blobId:e.blobId,asyncTaskId:t.async.uuid};return t.status===a.ASYNC_TASK_STATUS.SUCCESS&&(i.documentId=t.resourceUuid),r.createAttachment(i)}));return i(t)},watch:function(i,c){var s=n.defer(),u=!1,l=t((function(){if(u)return e.debug("Polling is already in progress, skip this turn");u=!0,a.getDocumentAsyncTaskById(i.asyncTaskId).then((function(n){if(n.status===a.ASYNC_TASK_STATUS.SUCCESS)return r.updateAttachment(i.id,{documentId:n.resourceUuid}).then((function(){h(null,n.resourceUuid)}));n.status===a.ASYNC_TASK_STATUS.FAILED&&h(new Error("Failed to save attachment to LinShare"))})).catch(h).finally((function(){u=!1}))}),o);return c.$on("$destroy",(function(){t.cancel(l)})),s.promise;function h(n,e){t.cancel(l),n?s.reject(n):s.resolve(e)}}}}e.$inject=["$q","$log","$interval","inBackground","linshareApiClient","inboxLinshareApiClient","INBOX_LINSHARE_ATTACHMENT_POLLING_INTERVAL"],n.module("linagora.esn.unifiedinbox.linshare").factory("inboxLinshareAttachmentSaveActionService",e)}(angular)},IyPb:function(n,e){!function(n){"use strict";function e(n,e,t,i,a,r){var o=this;function c(e){if(e){if(!e.documentId)return o.status=r.saving,a.watch(e,n).then(s);i.getDocument(e.documentId).then((function(){s(e.documentId)}),(function(){o.status=r.not_saved}))}else o.status=r.not_saved}function s(n){return o.status=r.saved,(e=n,t("linagora.esn.linshare.instanceURL").then((function(n){return n+"#/files/list?fileUuid="+e})).catch((function(){}))).then((function(n){o.attachmentUrl=n}));var e}o.$onInit=function(){o.status=r.checking,a.getAttachmentMapping(o.attachment).then(c).catch((function(){o.status=r.error}))},o.onSaveBtnClick=function(){o.status=r.saving,e({progressing:"Saving attachment to LinShare...",success:"Saved attachment to LinShare",failure:"Failed to save attachment to LinShare"},(function(){return a.saveAttachmentToLinshare(o.attachment).then(c)})).catch((function(){o.status=r.error}))}}e.$inject=["$scope","asyncAction","esnConfig","linshareApiClient","inboxLinshareAttachmentSaveActionService","INBOX_LINSHARE_ATTACHMENT_MAPPING_STATUS"],n.module("linagora.esn.unifiedinbox.linshare").controller("inboxLinshareAttachmentSaveActionController",e)}(angular)},VTQ0:function(n,e){!function(n){"use strict";n.module("linagora.esn.unifiedinbox.linshare").constant("INBOX_LINSHARE_ATTACHMENT_TYPE","linshare").constant("INBOX_LINSHARE_EMAIL_ADDITIONAL_MESSAGE_TEMPLATES",{plural:"This email contains %s LinShare attachments.",singular:"This email contains a LinShare attachment."}).constant("INBOX_LINSHARE_ATTACHMENT_POLLING_INTERVAL",1e3).constant("INBOX_LINSHARE_ATTACHMENT_MAPPING_STATUS",{checking:"checking",not_saved:"not_saved",saving:"saving",saved:"saved",error:"error"})}(angular)},VbJc:function(n,e){!function(n){"use strict";e.$inject=["inboxLinshareRestangular"],n.module("linagora.esn.unifiedinbox.linshare").factory("inboxLinshareApiClient",e);function e(n){return{createAttachment:function(t){return n.all("attachments").post({blobId:t.blobId,asyncTaskId:t.asyncTaskId,documentId:t.documentId}).then(e)},getAttachments:function(t){return n.all("attachments").getList(t).then(e)},updateAttachment:function(e,t){return n.one("attachments",e).customPOST(t)}};function e(e){return n.stripRestangular(e.data)}}}(angular)},Vqn6:function(n,e,t){"use strict";angular.module("linagora.esn.unifiedinbox.linshare").factory("inboxLinshareRestangular",["Restangular","httpErrorHandler",function(n,e){return n.withConfig((function(n){n.setFullResponse(!0),n.setBaseUrl("/linagora.esn.unifiedinbox.linshare/api"),n.setErrorInterceptor((function(n){return 401===n.status&&e.redirectToLogin(),!0}))}))}])},ZhS1:function(n,e){!function(n){"use strict";function e(n,e,t,i,a,r){return{name:"Linshare",type:r,icon:"linshare-icon linshare-desktop-icon",upload:function(t){var a=n.defer(),r=e.get(i),o=r.addFile(t.getFile());return o.defer.promise.then((function(n){t.uuid=n.response.uuid,a.resolve()}),a.reject,(function(n){a.notify(n.progress)})),r.start(),{cancel:o.cancel,promise:a.promise}},fileToAttachment:function(n){return{attachmentType:r,name:n.name,size:n.size,type:n.type||a,isInline:!1,getFile:function(){return n}}},removeAttachment:function(n,e){var i=t.getLinShareAttachmentUUIDsFromEmailHeader(n),a=i.indexOf(e.uuid);-1!==a&&i.splice(a,1);t.setLinShareAttachmentUUIDsToEmailHeader(n,i)}}}e.$inject=["$q","fileUploadService","inboxLinshareHelper","linshareFileUpload","DEFAULT_FILE_TYPE","INBOX_LINSHARE_ATTACHMENT_TYPE"],n.module("linagora.esn.unifiedinbox.linshare").factory("inboxLinshareAttachmentProvider",e)}(angular)},"i/hi":function(n,e){!function(n){"use strict";function e(n){var e=this;e.insert=function(){n(e.selectedNodes)}}e.$inject=["onInsert"],n.module("linagora.esn.unifiedinbox.linshare").controller("inboxLinshareFilesInserterController",e)}(angular)},oXHG:function(n,e){!function(n){function e(n){return{isConfigured:function(){return n("linagora.esn.linshare.instanceURL").then((function(n){return n&&n.length>0}))}}}e.$inject=["esnConfig"],n.module("linagora.esn.unifiedinbox.linshare").factory("linshareConfigurationService",e)}(angular)},ruhI:function(n,e){!function(n){"use strict";n.module("linagora.esn.unifiedinbox.linshare").component("inboxLinshareAttachmentSaveAction",{templateUrl:"/linagora.esn.unifiedinbox.linshare/app/attachment/save-action/inbox-linshare-attachment-save-action.html",controller:"inboxLinshareAttachmentSaveActionController",bindings:{attachment:"<"}})}(angular)},sAuz:function(n,e){!function(n){"use strict";n.module("linagora.esn.unifiedinbox.linshare").component("inboxLinshareComposerSelectAttachment",{templateUrl:"/linagora.esn.unifiedinbox.linshare/app/composer-select-attachment/composer-select-attachment.html",controller:"inboxLinshareComposerSelectAttachmentController",bindings:{email:"<",isMobile:"<"}})}(angular)},uu6i:function(n,e){!function(n){"use strict";function e(n,e,t,i,a){var r=this;function o(){n({templateUrl:"/linagora.esn.unifiedinbox.linshare/app/files-inserter/inbox-linshare-files-inserter.html",placement:"center",controllerAs:"$ctrl",controller:"inboxLinshareFilesInserterController",locals:{onInsert:c}})}function c(n){var e=i.getLinShareAttachmentUUIDsFromEmailHeader(r.email);n.forEach((function(n){var t=i.documentToAttachment(n);r.email.attachments.push(t),-1===e.indexOf(t.uuid)&&e.push(t.uuid)})),i.setLinShareAttachmentUUIDsToEmailHeader(r.email,e)}r.$onInit=function(){r.email.attachments=r.email.attachments||[],r.openLinshareFilesBrowser=o,r.linshareAttachmentsStatus={},e.$watch((function(){return t.filter(r.email.attachments,{attachmentType:a}).length}),(function(n){r.linshareAttachmentsStatus.number=n})),e.$watch((function(){return t.some(r.email.attachments,{status:"uploading",attachmentType:a})}),(function(n){r.linshareAttachmentsStatus.uploading=n})),e.$watch((function(){return t.some(r.email.attachments,{status:"error",attachmentType:a})}),(function(n){r.linshareAttachmentsStatus.error=n}))}}e.$inject=["$modal","$scope","_","inboxLinshareHelper","INBOX_LINSHARE_ATTACHMENT_TYPE"],n.module("linagora.esn.unifiedinbox.linshare").controller("inboxLinshareComposerSelectAttachmentController",e)}(angular)}});